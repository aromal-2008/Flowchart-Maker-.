<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Flow Architect | Aromal</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0b0f1a;
    --card: rgba(20, 26, 42, 0.9);
    --accent: #6366f1;
    --accent-glow: rgba(99, 102, 241, 0.3);
    --text: #f8fafc;
    --text-muted: #64748b;
    --border: rgba(255, 255, 255, 0.08);
    --node-bg: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    --panel-blur: 20px;
    --flow-speed: 2s;
  }

  /* ZEN THEME OVERRIDE */
  body.zen-mode {
    --bg: #051410;
    --accent: #10b981;
    --accent-glow: rgba(16, 185, 129, 0.3);
    --node-bg: linear-gradient(135deg, #064e3b 0%, #022c22 100%);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0; padding: 0;
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    background-image: 
      radial-gradient(at 0% 0%, var(--accent-glow) 0px, transparent 50%),
      radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
    color: var(--text);
    overflow: hidden;
    height: 100vh;
    touch-action: none;
    transition: background 0.8s ease;
  }

  /* --- HOME SCREEN --- */
  #home-screen {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 5000; padding: 20px;
  }
  .home-card {
    background: var(--card);
    backdrop-filter: blur(var(--panel-blur));
    padding: 40px; border-radius: 32px;
    border: 1px solid var(--border);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
    width: 100%; max-width: 420px;
    text-align: center;
  }
  .home-card h1 { font-weight: 800; font-size: 32px; margin: 0 0 4px; letter-spacing: -1.5px; }
  .maker-tag { font-size: 11px; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 24px; display: block; }

  /* --- UI COMPONENTS --- */
  input[type="text"] {
    width: 100%; padding: 16px; border-radius: 16px;
    border: 1px solid var(--border); background: rgba(0,0,0,0.4);
    color: white; font-family: inherit; font-size: 15px;
    transition: all 0.3s; margin-bottom: 12px;
  }
  input:focus { outline: none; border-color: var(--accent); background: rgba(0,0,0,0.6); box-shadow: 0 0 0 4px var(--accent-glow); }

  .btn-primary {
    width: 100%; padding: 16px; border-radius: 16px;
    background: var(--accent); color: white; border: none;
    font-weight: 700; font-size: 16px; cursor: pointer;
    transition: all 0.2s; box-shadow: 0 8px 20px var(--accent-glow);
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 24px var(--accent-glow); }
  
  .btn-outline {
    width: 100%; padding: 14px; border-radius: 16px;
    background: transparent; color: white; border: 1px solid var(--border);
    font-weight: 600; font-size: 14px; cursor: pointer; margin-top: 12px;
  }

  /* --- HEADER & BRANDING --- */
  #editor-screen { display: none; flex-direction: column; height: 100vh; }
  header {
    height: 80px; padding: 0 20px; display: flex; align-items: center; 
    gap: 12px; z-index: 1000; position: relative; 
    background: rgba(11, 15, 26, 0.4); backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }
  
  .app-icon-container {
    width: 48px; height: 48px; background: var(--accent);
    border-radius: 14px; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 15px var(--accent-glow); flex-shrink: 0; cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .app-icon-container:active { transform: scale(0.9) rotate(-10deg); }
  .app-icon-container svg { position: static; pointer-events: none; width: 24px; height: 24px; display: block; }

  .header-info { display: flex; flex-direction: column; justify-content: center; flex: 1; }
  .project-title {
    font-weight: 800; font-size: 18px; color: var(--text);
    border: none; background: transparent; outline: none; padding: 0; margin: 0;
  }
  .header-maker { font-size: 10px; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 2px; }

  .stats-badge {
    padding: 6px 12px; border-radius: 10px; background: rgba(255,255,255,0.05);
    border: 1px solid var(--border); font-size: 10px; font-weight: 700;
    display: flex; gap: 8px; align-items: center; color: var(--text-muted);
  }

  /* --- SIDEBAR --- */
  #sidebar {
    position: fixed; top: 15px; left: -320px;
    width: 300px; height: calc(100% - 30px);
    background: var(--card); backdrop-filter: blur(var(--panel-blur));
    z-index: 4000; transition: left 0.5s cubic-bezier(0.19, 1, 0.22, 1);
    border-radius: 28px; border: 1px solid var(--border);
    padding: 30px; box-shadow: 20px 0 60px rgba(0,0,0,0.6);
    overflow-y: auto;
  }
  #sidebar.open { left: 15px; }
  .sidebar-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    display: none; z-index: 3900; backdrop-filter: blur(8px);
  }
  .sidebar-overlay.active { display: block; }

  /* --- CANVAS --- */
  #viewport { flex: 1; position: relative; overflow: hidden; background: transparent; }
  #canvas-container { position: absolute; transform-origin: 0 0; pointer-events: none; }
  .wrapper { position: absolute; pointer-events: auto; }
  
  .node {
    padding: 24px 30px; background: var(--node-bg);
    border: 1px solid var(--border); border-radius: 24px;
    text-align: center; min-width: 220px; outline: none;
    font-weight: 600; color: var(--text);
    box-shadow: 0 15px 40px rgba(0,0,0,0.5);
    transition: all 0.3s;
    animation: nodePulse 8s infinite ease-in-out;
  }
  @keyframes nodePulse {
    0%, 100% { border-color: var(--border); }
    50% { border-color: var(--accent-glow); }
  }
  .node:focus { border-color: var(--accent); box-shadow: 0 0 0 5px var(--accent-glow); }
  
  .coord-tag {
    position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
    background: var(--accent); color: white; font-size: 11px;
    padding: 4px 14px; border-radius: 20px; font-weight: 800;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none; z-index: 10;
  }
  body.show-coords .coord-tag { display: block; }

  .node-btn {
    position: absolute; width: 38px; height: 38px;
    color: white; border-radius: 12px; border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; z-index: 200; cursor: pointer;
    backdrop-filter: blur(12px); transition: all 0.2s;
  }
  .node-btn:hover { transform: scale(1.1); }
  .add-btn { bottom: -19px; left: calc(50% - 19px); background: #10b981; }
  .del-btn { top: -5px; right: -15px; background: #ef4444; }

  #svg-layer { position: absolute; inset: 0; pointer-events: none; overflow: visible; }
  .flow-line { 
    fill: none; stroke: var(--accent); stroke-width: 4; 
    stroke-linecap: round; opacity: 0.4;
    stroke-dasharray: 8 12;
    animation: flowLineAnim 30s linear infinite;
  }
  @keyframes flowLineAnim {
    to { stroke-dashoffset: -500; }
  }

  /* --- SIDEBAR CONTENT --- */
  .section-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 800; letter-spacing: 2.5px; margin: 32px 0 14px; display: block; }
  .move-box { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 24px; border: 1px solid var(--border); }
  .move-row { display: flex; gap: 12px; margin-bottom: 12px; }
  .move-row input { margin-bottom: 0; text-align: center; font-weight: 800; text-transform: uppercase; background: rgba(0,0,0,0.3); }

  #error-msg { color: #f87171; font-size: 12px; margin-top: 12px; font-weight: 700; display: none; text-align: center; }

  .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .switch { width: 50px; height: 28px; position: relative; cursor: pointer; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; inset: 0; background: #1e293b; border-radius: 24px; transition: .4s cubic-bezier(0.4, 0, 0.2, 1); }
  .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .4s; }
  input:checked + .slider { background: var(--accent); }
  input:checked + .slider:before { transform: translateX(22px); }
</style>
</head>
<body>

<div id="home-screen">
  <div class="home-card">
    <div class="app-icon-container" style="width: 80px; height: 80px; margin: 0 auto 24px; cursor: default;">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" style="width: 40px; height: 40px;">
        <rect x="3" y="3" width="7" height="7" rx="1"/>
        <rect x="14" y="3" width="7" height="7" rx="1"/>
        <rect x="14" y="14" width="7" height="7" rx="1"/>
        <rect x="3" y="14" width="7" height="7" rx="1"/>
        <path d="M10 6.5h4M6.5 10v4M17.5 10v4M10 17.5h4"/>
      </svg>
    </div>
    <h1>Flow Architect</h1>
    <span class="maker-tag">By Aromal</span>
    <p>Professional Branching Systems & Hierarchy Visualization</p>
    <input type="text" id="project-name" placeholder="Name your project...">
    <button class="btn-primary" onclick="start()">Initialize System</button>
    <button class="btn-outline" onclick="triggerFile()">Load Workspace</button>
  </div>
</div>

<div class="sidebar-overlay" id="overlay" onclick="toggleMenu()"></div>
<div id="sidebar">
  <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
    <div>
      <h2 style="margin:0; font-size: 24px; font-weight: 800;">Workspace</h2>
      <div class="header-maker">Aromal Architect Edition</div>
    </div>
    <div style="cursor:pointer; font-size: 20px; font-weight: 800;" onclick="toggleMenu()">✕</div>
  </div>

  <span class="section-label">System Mode</span>
  <div class="toggle-row">
    <span>Focus (Zen) Mode</span>
    <label class="switch"><input type="checkbox" id="zen-sw" onchange="toggleZen()"><span class="slider"></span></label>
  </div>
  
  <span class="section-label">View Configuration</span>
  <div class="toggle-row">
    <span>Enable Coordinates</span>
    <label class="switch"><input type="checkbox" id="coord-sw" onchange="toggleC()"><span class="slider"></span></label>
  </div>

  <span class="section-label">Structural Logic</span>
  <div class="move-box">
    <div class="move-row">
      <input type="text" id="m-src" placeholder="FROM">
      <input type="text" id="m-dst" placeholder="TO">
    </div>
    <button class="btn-primary" style="background:#f59e0b; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);" onclick="doMove()">Relocate Branch</button>
    <div id="error-msg">Coordinate mapping failed.</div>
  </div>

  <span class="section-label">File Management</span>
  <button class="btn-primary" onclick="exportJ()">Export Project (.json)</button>
  <button class="btn-primary" style="background: #10b981; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); margin-top:12px;" onclick="exportP()">Save High-Res PNG</button>
  <button class="btn-outline" onclick="triggerFile()">Import Backup</button>
  <input type="file" id="file-in" accept=".json" style="display:none;" onchange="loadF(event)">
</div>

<div id="editor-screen">
  <header>
    <div class="app-icon-container" onclick="toggleMenu()">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
        <path d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </div>
    <div class="header-info">
      <input type="text" class="project-title" id="active-title" value="Project One">
      <div class="header-maker">Created by Aromal</div>
    </div>
    <div class="stats-badge" id="stats-area">
      <span id="stat-nodes">1 Nodes</span>
      <span style="opacity:0.3">|</span>
      <span id="stat-depth">L1 Depth</span>
    </div>
  </header>

  <div id="viewport">
    <div id="canvas-container">
      <svg id="svg-layer"></svg>
    </div>
  </div>
</div>

<script>
  let nodes = [], scale = 1, ox = window.innerWidth/2-110, oy = 150;
  const canvas = document.getElementById('canvas-container'), vp = document.getElementById('viewport'), svg = document.getElementById('svg-layer');

  function toggleMenu() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('active');
    document.getElementById('error-msg').style.display = 'none';
  }

  function start() {
    const t = document.getElementById('project-name').value || "Project One";
    document.getElementById('active-title').value = t;
    document.getElementById('home-screen').style.display = 'none';
    document.getElementById('editor-screen').style.display = 'flex';
    create('Master Controller'); layout(); updateVP();
  }

  function toggleC() { document.body.classList.toggle('show-coords'); layout(); }
  function toggleZen() { document.body.classList.toggle('zen-mode'); layout(); }
  function triggerFile() { document.getElementById('file-in').click(); }

  // --- ENGINE ---
  function create(txt, parent = null) {
    const w = document.createElement('div'); w.className = 'wrapper';
    const n = { w, parent, children: [], x: 0, y: 0, coord: '' };
    
    const div = document.createElement('div');
    div.className = 'node'; div.contentEditable = true; div.innerText = txt;
    div.oninput = () => layout();

    const tag = document.createElement('div'); tag.className = 'coord-tag';
    div.appendChild(tag); n.tag = tag;

    const add = document.createElement('div');
    add.className = 'node-btn add-btn'; add.innerHTML = '+';
    add.onclick = (e) => { e.stopPropagation(); n.children.push(create('Sub-Process', n)); layout(); };

    if (parent) {
      const del = document.createElement('div');
      del.className = 'node-btn del-btn'; del.innerHTML = '✕';
      del.onclick = (e) => { e.stopPropagation(); delN(n); };
      w.appendChild(del);
    }

    w.appendChild(div); w.appendChild(add);
    canvas.appendChild(w); n.el = div; nodes.push(n);
    return n;
  }

  function delN(t) {
    const k = (n) => { n.children.forEach(k); n.w.remove(); nodes = nodes.filter(x => x !== n); };
    if (t.parent) t.parent.children = t.parent.children.filter(c => c !== t);
    k(t); layout();
  }

  function doMove() {
    const sC = document.getElementById('m-src').value.toUpperCase().trim();
    const dC = document.getElementById('m-dst').value.toUpperCase().trim();
    const err = document.getElementById('error-msg');
    const sN = nodes.find(n => n.coord === sC), dN = nodes.find(n => n.coord === dC);

    if (!sN || !dN || !sN.parent || sN === dN) { err.style.display = 'block'; return; }
    let c = dN; while(c) { if (c === sN) { err.style.display = 'block'; return; } c = c.parent; }

    sN.parent.children = sN.parent.children.filter(x => x !== sN);
    sN.parent = dN; dN.children.push(sN);
    layout(); toggleMenu();
    document.getElementById('m-src').value = ''; document.getElementById('m-dst').value = '';
  }

  function updateStats() {
    document.getElementById('stat-nodes').innerText = `${nodes.length} Nodes`;
    let maxD = 0;
    const findD = (n, d) => { maxD = Math.max(maxD, d); n.children.forEach(c => findD(c, d+1)); };
    if (nodes.length) findD(nodes[0], 1);
    document.getElementById('stat-depth').innerText = `L${maxD} Depth`;
  }

  function layout() {
    if (!nodes.length) return;
    svg.innerHTML = '';
    const r = (n, d, i) => {
      n.coord = `${String.fromCharCode(65+d)}${i+1}`;
      n.tag.innerText = n.coord;
      n.children.forEach((c, idx) => r(c, d+1, idx));
    };
    r(nodes[0], 0, 0);
    const m = (n) => {
      n.bw = Math.max(n.el.offsetWidth, 220);
      if (!n.children.length) n.sw = n.bw + 80;
      else { let w = 0; n.children.forEach(c => { m(c); w += c.sw; }); n.sw = Math.max(w, n.bw + 80); }
    };
    m(nodes[0]);
    const p = (n, x, y) => {
      n.x = x + (n.sw/2) - (n.bw/2); n.y = y;
      n.w.style.left = n.x + 'px'; n.w.style.top = n.y + 'px';
      let cx = x; n.children.forEach(c => { p(c, cx, y+220); cx += c.sw; });
    };
    p(nodes[0], 0, 0);
    nodes.forEach(n => { if (n.parent) line(n.parent, n); });
    updateStats();
  }

  function line(a, b) {
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const x1 = a.x + a.el.offsetWidth/2, y1 = a.y + a.el.offsetHeight, x2 = b.x + b.el.offsetWidth/2, y2 = b.y;
    path.setAttribute('d', `M ${x1} ${y1} C ${x1} ${(y1+y2)/2}, ${x2} ${(y1+y2)/2}, ${x2} ${y2}`);
    path.className.baseVal = 'flow-line'; svg.appendChild(path);
  }

  // --- TOUCH HANDLERS ---
  let pan = false, lx, ly, sd, ss;
  vp.addEventListener('touchstart', e => {
    if (e.target.closest('.node-btn') || e.target.closest('.node')) return;
    if (e.touches.length === 1) { pan = true; lx = e.touches[0].clientX; ly = e.touches[0].clientY; }
    else if (e.touches.length === 2) { 
      pan = false; 
      sd = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); 
      ss = scale; 
    }
  });
  vp.addEventListener('touchmove', e => {
    e.preventDefault();
    if (e.touches.length === 1 && pan) { ox += e.touches[0].clientX-lx; oy += e.touches[0].clientY-ly; lx = e.touches[0].clientX; ly = e.touches[0].clientY; }
    else if (e.touches.length === 2) {
      const d = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
      const mx = (e.touches[0].clientX+e.touches[1].clientX)/2, my = (e.touches[0].clientY+e.touches[1].clientY)/2;
      const ps = scale; scale = Math.max(0.1, Math.min(3, ss * (d/sd)));
      ox = mx - (mx-ox)*(scale/ps); oy = my - (my-oy)*(scale/ps);
    }
    updateVP();
  });
  function updateVP() { canvas.style.transform = `translate(${ox}px, ${oy}px) scale(${scale})`; }

  // --- IO ---
  function exportJ() {
    const t = document.getElementById('active-title').value;
    const s = (n) => ({ text: n.el.innerText, children: n.children.map(s) });
    const a = document.createElement('a'); a.download = `${t}.json`;
    a.href = URL.createObjectURL(new Blob([JSON.stringify({title:t, data:s(nodes[0])})], {type:'application/json'}));
    a.click(); toggleMenu();
  }
  function loadF(e) {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader(); r.onload = v => {
      const p = JSON.parse(v.target.result); nodes.forEach(n => n.w.remove()); nodes = [];
      const b = (d, par = null) => { const n = create(d.text, par); if(d.children) d.children.forEach(c => n.children.push(b(c, n))); return n; };
      b(p.data || p); document.getElementById('active-title').value = p.title || "Imported Workspace";
      document.getElementById('home-screen').style.display = 'none';
      document.getElementById('editor-screen').style.display = 'flex';
      layout(); updateVP();
    };
    r.readAsText(f); e.target.value = '';
  }
  function exportP() {
    const t = document.getElementById('active-title').value, p = 100, h = 180;
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    nodes.forEach(n => { minX = Math.min(minX, n.x); minY = Math.min(minY, n.y); maxX = Math.max(maxX, n.x+n.el.offsetWidth); maxY = Math.max(maxY, n.y+n.el.offsetHeight); });
    const c = document.createElement('canvas'), cw = maxX-minX, ch = maxY-minY;
    c.width = cw+p*2; c.height = ch+p*2+h;
    const ctx = c.getContext('2d'), sx = p-minX, sy = p+h-minY;
    const isZen = document.body.classList.contains('zen-mode');
    ctx.fillStyle = isZen ? '#051410' : '#0b0f1a'; ctx.fillRect(0,0,c.width,c.height);
    ctx.fillStyle = isZen ? '#10b981' : '#6366f1'; ctx.font = '800 52px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(t, c.width/2, 80);
    ctx.font = '800 12px sans-serif'; ctx.globalAlpha = 0.6; ctx.fillText('SYSTEM ARCHITECTURE BY AROMAL', c.width/2, 120); ctx.globalAlpha = 1;
    ctx.strokeStyle = isZen ? '#10b981' : '#6366f1'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.globalAlpha = 0.4;
    nodes.forEach(n => { if (n.parent) { 
      const x1 = n.parent.x+n.parent.el.offsetWidth/2+sx, y1 = n.parent.y+n.parent.el.offsetHeight+sy;
      const x2 = n.x+n.el.offsetWidth/2+sx, y2 = n.y+sy;
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.bezierCurveTo(x1,(y1+y2)/2, x2,(y1+y2)/2, x2,y2); ctx.stroke();
    }});
    ctx.globalAlpha = 1;
    nodes.forEach(n => {
      const nx = n.x+sx, ny = n.y+sy, nw = n.el.offsetWidth, nh = n.el.offsetHeight;
      ctx.fillStyle = isZen ? '#064e3b' : '#1e293b'; ctx.strokeStyle = 'rgba(255,255,255,0.1)';
      ctx.beginPath(); ctx.roundRect(nx, ny, nw, nh, 24); ctx.fill(); ctx.stroke();
      ctx.fillStyle = '#fff'; ctx.font = '600 16px sans-serif'; ctx.fillText(n.el.innerText, nx+nw/2, ny+nh/2+6);
      if(document.body.classList.contains('show-coords')) {
        ctx.fillStyle = isZen ? '#10b981' : '#6366f1'; ctx.beginPath(); ctx.roundRect(nx+nw/2-25, ny-14, 50, 24, 12); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.font = '800 11px sans-serif'; ctx.fillText(n.coord, nx+nw/2, ny+3);
      }
    });
    const a = document.createElement('a'); a.download = `${t}.png`; a.href = c.toDataURL(); a.click();
  }
</script>
</body>
</html>

